async function convertAllToZip(){
  const cards = $$(".bg-gray-50.rounded-xl.p-4");
  if(cards.length===0) return;

  el.btnAll.disabled = true;
  const zip = new JSZip();
  let done = 0;

  for(const card of cards){
    const statusEl = $(".status", card);
    const file = card._file;            // <— prendiamo il File dal card
    if(!file) continue;

    statusEl.textContent = 'Conversione…';
    const blob = await convertToWEBP(file, parseFloat(el.q.value || '0.85'));

    // Aggiorna UI per ogni card
    const convertedRow = $(".converted", card);
    const sizeOut = $(".converted .size", card);
    sizeOut.textContent = human(blob.size);
    convertedRow.classList.remove('hidden');

    const savingRow = $(".saving", card);
    const pctOut   = $(".saving .pct", card);
    const savedOut = $(".saving .saved", card);
    const savedBytes = Math.max(0, file.size - blob.size);
    const pct = file.size > 0 ? (savedBytes / file.size) * 100 : 0;
    savedOut.textContent = human(savedBytes);
    pctOut.textContent = (Math.round(pct * 10) / 10).toLocaleString(undefined, { maximumFractionDigits: 1 });
    savingRow.classList.remove('hidden');

    // Nome file di output coerente con l’opzione suffisso
    const outName = makeWebpName(file.name, el.rename.checked);
    zip.file(outName, blob);

    statusEl.textContent = 'Fatto ✓';
    done++;
    await new Promise(r=> setTimeout(r, 0)); // yield UI
  }

  // Genera e scarica lo ZIP
  const zipBlob = await zip.generateAsync({type:'blob'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(zipBlob);
  a.download = 'converted-webp.zip';
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=> URL.revokeObjectURL(a.href), 1500);

  el.btnAll.disabled = false;
  notify(`Convertiti ${done} file`);
}
